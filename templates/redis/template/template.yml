api: v1

meta:
  name: Redis
  description: An open-source key-value datastore.

form:

  - title: General
    questions:

      - variable: version
        label: Version
        hint: > 
          The version of Redis datastore.
        required: true
        immutable: true
        type: select
        options:
          - value: 5
            label: 5
          - value: 6
            label: 6
        default: 6

      - variable: memory
        label: Memory
        hint: >
          The amount of memory allocated to the Redis database.
        type: binary_number
        minimum: 1024
        default: 2048

      - variable: cpus
        label: CPU
        hint: >
          The number of CPU millicores allocated to the Redis database.
        type: number
        default: 1000

  - title: Authentication
    questions:

      - variable: password
        label: Password
        hint: >
          The password of the datastore that is configured the first time that the service is 
          installed on a server.
        required: true
        immutable: true
        type: password
        default: "{{ environment.REDIS_PASSWORD }}"

deployment:

  - resource: volume
    name: redis_5
    if: "{{ variable.version == 5 }}"

  - resource: volume
    name: redis_6
    if: "{{ variable.version == 6 }}"

  - resource: container
    name: redis
    image:
      switch:
        - case: "{{ variable.version == 5 }}"
          value: bitnami/redis:5.0
        - case: "{{ variable.version == 6 }}"
          value: bitnami/redis:6.0
    volume_mounts:
      - volume: "{* volume.redis_5 *}"
        mount_path: /bitnami/redis/data
        if: "{{ variable.version == 5 }}"
      - volume: "{* volume.redis_6 *}"
        mount_path: /bitnami/redis/data
        if: "{{ variable.version == 6 }}"
    environment:
      - key: REDIS_PASSWORD
        value: "{{ variable.password }}"
    memory: "{{ variable.memory }}"
    cpus: "{{ variable.cpus }}"

  - resource: entrypoint
    name: redis
    title: Redis database
    container: "{* container.redis *}"
    port: 6379

interface:
  shared_variables:
    REDIS_URL: "redis://:{{ variable.password }}@{{ entrypoint.redis.host }}:{{ entrypoint.redis.port }}"
    REDIS_HOST: "{{ entrypoint.redis.host }}"
    REDIS_PORT: "{{ entrypoint.redis.port }}"
    REDIS_PASSWORD: "{{ variable.password }}"
  logs:
  
    - title: Redis logs
      container: "{* container.redis *}"
